#!/bin/bash

cd $(dirname $0)

shopt -s globstar

script_file=$(mktemp)
out_file=$(mktemp)

# Install the file in $1 to $2.
# This keeps backups and warns if the destination file has changed
# since this was last ran.
function install_file() {
	src=$1
	dest_path=$2
	
	# Make a backup in the .backup dir.
	backup_path=.backup$dest_path
	
	# If the destination and the backup exists, check the diff.
	# Stop if only the destination exists, or the diff is diferent.
	if [ -f "$dest_path" ]; then
		if [ -f "$backup_path" ]; then
			if ! diff -c "$backup_path" "$dest_path"; then
				echo "WARNING: $dest_path changed since last run. Not updating."
				return 1
			fi
		else
			echo "WARNING: $dest_path not generated by this script. Not updating."
			return 1
		fi
	fi
	
	# Perform the install.
	mkdir -p $(dirname $backup_path) $(dirname $dest_path)
	cp $src $dest_path
	cp $src $backup_path
}

# Source all scripts in the scripts directory.
for script in plugins/**/*.sh; do
	source "$script"
done

# Build a list of plugin m4 files to be included.
m4_plugins=(plugins/**/*.m4)

# Save the command line args so that they can be accessed within functions.
script_args=("$@")

# Generate the config file with id $1, name $2, and install it in $3.
function config_file() {
	id=$1
	name=$2
	path=$3
	
	# Generate the config file.
	m4 \
		-DSCRIPT_FILE=/dev/null \
		-DOUTPUT_ID=$id \
		-Iconfigs \
		"${script_args[@]}" \
		header.m4 "${m4_plugins[@]}" $config_file > $out_file || continue
	# ...and install it.
	install_file $out_file $path
}

# Process all m4 files that aren't '*.inc.m4'
find configs -name '*.m4' '!' -name '*.inc.m4' | while read config_file; do
	# Generate and run the corresponding script.
	m4 \
		-DSCRIPT_FILE=$script_file \
		-Iconfigs \
		"${script_args[@]}" \
		header.m4 "${m4_plugins[@]}" $config_file > /dev/null || continue
	source $script_file || continue
done

rm $out_file $script_file
