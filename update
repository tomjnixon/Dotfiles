#!/bin/bash

cd $(dirname $0)

script_file=$(mktemp)
out_file=$(mktemp)

# Install the file in $1 to $2.
# This keeps backups and warns if the destination file has changed
# since this was last ran.
function install_file() {
	src=$1
	dest_path=$2
	
	# Make a backup in the .backup dir.
	backup_path=.backup$dest_path
	
	# If the destination and the backup exists, check the diff.
	# Stop if only the destination exists, or the diff is diferent.
	if [ -f "$dest_path" ]; then
		if [ -f "$backup_path" ]; then
			if ! diff -c "$backup_path" "$dest_path"; then
				echo "WARNING: $dest_path changed since last run. Not updating."
				return 1
			fi
		else
			echo "WARNING: $dest_path not generated by this script. Not updating."
			return 1
		fi
	fi
	
	# Perform the install.
	mkdir -p $(dirname $backup_path) $(dirname $dest_path)
	cp $src $dest_path
	cp $src $backup_path
}

# Stores a map from argument -> action, where action is executed with eval.
typeset -A arguments
typeset -A arguments_help

function add_argument() {
	arguments[$1]=$2
	arguments_help[$1]=$3
}

function print_help() {
	echo "Usage: $0 [OPTION]"
	echo
	for option in "${!arguments_help[@]}"; do
		printf "  %-10s  %s\n" $option  "${arguments_help[$option]}"
	done
	echo
}

add_argument -h "print_help; exit 1" "Display this message."

# Source all scripts in the scripts directory.
for script in scripts/* ; do
	[ -x "$script" ] && source $script
done

# Parse all command line args. In the context of the action, $1 is the next
# argument, and should be shifted if used.
while (($#)); do 
	arg=$1
	shift
	eval "${arguments[$arg]}"
done

# Generate the config file with id $1, name $2, and install it in $3.
function config_file() {
	id=$1
	name=$2
	path=$3
	
	# Generate the config file.
	m4 \
		-DSCRIPT_FILE=/dev/null \
		-DOUTPUT_ID=$id \
		-Iconfigs \
		header.m4 $config_file > $out_file || continue
	# ...and install it.
	install_file $out_file $path
}

# Process all m4 files that aren't '*.inc.m4'
find configs -name '*.m4' '!' -name '*.inc.m4' | while read config_file; do
	# Generate and run the corresponding script.
	m4 \
		-DSCRIPT_FILE=$script_file \
		-Iconfigs \
		header.m4 $config_file > /dev/null || continue
	source $script_file || continue
done

rm $out_file $script_file
